<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Cat√°logo completo de mobiliario corporativo JEMMSA. Sillas ergon√≥micas, estaciones de trabajo y salas colaborativas de alta calidad." />
  <meta property="og:title" content="Cat√°logo | JEMMSA Mobiliario Corporativo" />
  <meta property="og:description" content="Explora nuestro cat√°logo de soluciones de mobiliario moderno, ergon√≥mico y durable." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://jemmsa.com/catalogo.html" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Cat√°logo | JEMMSA" />
  <meta name="twitter:description" content="Mobiliario corporativo de alta calidad." />
  <title>Cat√°logo | Jemmsa</title>
  <link rel="icon" type="image/png" href="../public/img/Logo.png" />
  
  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RNW2ZEEL4S"></script>
  <script>
        // Utilidad para normalizar texto mostrado (ortograf√≠a y acentos comunes)
        function normalizeText(t) {
          if (!t) return '';
          return t
            .replace(/semi-?r[i√≠]gido/gi, 'semirr√≠gido')
            .replace(/polipropileno\s+semirr[i√≠]gido/gi, 'polipropileno semirr√≠gido')
            .replace(/elevacion/gi, 'elevaci√≥n')
            .replace(/terminacion/gi, 'terminaci√≥n')
            .trim();
        }
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-RNW2ZEEL4S');
  </script>
  
  <!-- JSON-LD Schema -->
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "CollectionPage",
      "name": "Cat√°logo JEMMSA",
      "description": "Cat√°logo completo de mobiliario corporativo ergon√≥mico y moderno",
      "url": "https://jemmsa.com/catalogo.html",
      "isPartOf": {
        "@type": "WebSite",
        "name": "JEMMSA",
        "url": "https://jemmsa.com"
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: {
              primary: '#1FA3D6',
              accent: '#C62828',
              warning: '#F4E300',
              base: '#0B0B0B',
              soft: '#F5F5F5',
              muted: '#8A8A8A',
              deep: '#3A3A3A'
            }
          },
          fontFamily: {
            display: ['"Space Grotesk"', 'system-ui', 'sans-serif'],
            body: ['Inter', 'system-ui', 'sans-serif']
          },
          boxShadow: {
            card: '0 10px 40px -20px rgba(31, 163, 214, 0.25)',
            'card-strong': '0 18px 50px -20px rgba(31, 163, 214, 0.35)'
          },
          keyframes: {
            'fade-in': { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            'slide-up': { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
          },
          animation: {
            'fade-in': 'fade-in 0.4s ease-out',
            'slide-up': 'slide-up 0.6s ease-out'
          }
        }
      }
    };
  </script>
  <style>
    :root {
      --bg-page: #ffffff;
      --text-main: #0B0B0B;
    }
    .dark {
      --bg-page: #0B0B0B;
      --text-main: #F5F5F5;
    }
    body {
      background-color: var(--bg-page);
      color: var(--text-main);
      transition: background-color 0.3s, color 0.3s;
    }
    .cursor-zoom-in {
      cursor: zoom-in;
    }
  </style>
</head>
<body class="font-body bg-[var(--bg-page)] text-[var(--text-main)]">
  <header id="header"></header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
    <!-- Breadcrumb -->
    <nav id="breadcrumb" class="text-sm text-slate-600 dark:text-slate-400 mb-6 flex items-center gap-2">
      <a href="./index.html" class="text-brand-primary hover:text-brand-primary/80 transition-colors">Inicio</a>
      <span>/</span>
      <span class="text-slate-700 dark:text-slate-300">Cat√°logo</span>
    </nav>

    <!-- Filter Section -->
    <section class="mb-12 space-y-6">
      <div class="flex flex-col gap-4">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <div class="flex-1">
            <label for="search-input" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Buscar productos</label>
            <input id="search-input" type="search" placeholder="Ej. silla ejecutiva, cuero, aluminio" class="w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-brand-primary transition-colors" />
          </div>
          <button id="clear-search" class="self-start sm:self-center px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">Limpiar</button>
        </div>
        
        <div class="flex flex-col sm:flex-row sm:items-center gap-4">
          <h2 class="font-display font-bold text-2xl text-brand-base dark:text-white">Categor√≠as</h2>
          
          <!-- Dropdown Filtro -->
          <div class="relative">
            <button id="filter-dropdown-btn" class="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-medium hover:bg-slate-300 dark:hover:bg-slate-600 transition-all flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
              </svg>
              Todas las categor√≠as
            </button>
            
            <div id="filter-dropdown-menu" class="hidden absolute left-0 mt-2 w-64 bg-white dark:bg-slate-900 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 z-50 max-h-96 overflow-y-auto">
              <div class="p-4 space-y-2" id="filter-dropdown-content">
                <!-- Content generated by JS -->
              </div>
            </div>
          </div>
        </div>
        
      </div>

      <div id="category-extras" class="space-y-4"></div>
    </section>

    <!-- Products Grid -->
    <section class="space-y-8">
      <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in">
        <!-- Products rendered by JavaScript -->
      </div>
      
      <div id="no-results" class="hidden text-center py-12 space-y-4">
        <p class="text-lg text-slate-600 dark:text-slate-400">No se encontraron productos en esta categor√≠a</p>
        <button onclick="renderAllProducts()" class="inline-block px-6 py-2 bg-brand-primary text-white rounded-lg hover:bg-brand-primary/90 transition-colors font-medium">
          Ver todas las categor√≠as
        </button>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer id="footer"></footer>

  <script>
    let catalogData = null;

    async function loadCatalogData() {
      try {
        console.log('‚è≥ Fetching ../data.json...');
        const response = await fetch('../data.json');
        if (!response.ok) throw new Error('HTTP ' + response.status);
        
        catalogData = await response.json();
        
        console.log('‚úì Cat√°logo cargado');
        console.log('  Categor√≠as:', catalogData.categories?.length || 0);
        console.log('  Productos:', Object.keys(catalogData.products || {}).length);
        
        // Verificar primera imagen
        try {
          const firstProd = catalogData.products?.directivos?.alufsen?.products?.[0];
          if (firstProd) {
            console.log('  Primer producto:', firstProd.name);
            console.log('  Imagen:', firstProd.image);
          }
        } catch(e) {}
      } catch (error) {
        console.error('‚úó Error cargando data.json:', error);
        catalogData = { categories: [], products: {} };
      }
    }


    const categoryExtras = document.getElementById('category-extras');
    let breadcrumb = { category: null, subcategory: null, subsubcategory: null };

    function setCategoryExtras(category) {
      categoryExtras.innerHTML = '';
    }

    function updateBreadcrumb() {
      const breadcrumbEl = document.getElementById('breadcrumb');
      let html = '<a href="./catalogo.html" class="text-brand-primary hover:text-brand-primary/80 transition-colors">Home</a>';
      
      if (breadcrumb.category) {
        const catName = catalogData.categories.find(c => c.id === breadcrumb.category)?.name;
        html += ` ‚Ä∫ <a href="#" class="text-blue-600 hover:text-blue-700" data-navigate-category="${breadcrumb.category}">${catName}</a>`;
      }
      
      if (breadcrumb.subcategory) {
        const subcatData = catalogData.products[breadcrumb.category][breadcrumb.subcategory];
        const subName = subcatData?.name || subcatData?.id;
        html += ` ‚Ä∫ <a href="#" class="text-blue-600 hover:text-blue-700" data-navigate-subcategory="${breadcrumb.subcategory}">${subName}</a>`;
      }
      
      if (breadcrumb.subsubcategory) {
        const subsubcatData = catalogData.products[breadcrumb.category][breadcrumb.subcategory][breadcrumb.subsubcategory];
        const subsubName = subsubcatData?.name || subsubcatData?.id;
        html += ` ‚Ä∫ <span class="text-slate-700">${subsubName}</span>`;
      }
      
      breadcrumbEl.innerHTML = html;
      attachBreadcrumbListeners();
    }

    function attachBreadcrumbListeners() {
      document.querySelectorAll('[data-navigate-category]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          breadcrumb.category = e.target.dataset.navigateCategory;
          breadcrumb.subcategory = null;
          breadcrumb.subsubcategory = null;
          renderCategoryProducts(breadcrumb.category);
        });
      });

      document.querySelectorAll('[data-navigate-subcategory]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          breadcrumb.subsubcategory = null;
          renderSubcategoryProducts(breadcrumb.category, e.target.dataset.navigateSubcategory);
        });
      });
    }

    // Selecciona la mejor imagen para mostrar en tarjetas del cat√°logo
    // Usa la misma l√≥gica que product-view.js para consistencia
    function getBestProductImage(product) {
      if (!product) {
        console.warn('‚ùå getBestProductImage: producto nulo');
        return '/public/img/subcategorias/notfound.png';
      }
      
      // Usar product.image como en product-view.js
      if (product.image) {
        console.log('  Usando imagen principal:', product.image);
        return product.image;
      }
      
      // Si no hay imagen principal, buscar en el array de im√°genes
      if (product.images && Array.isArray(product.images) && product.images.length > 0) {
        // Prioridad 1: Buscar im√°genes ambientadas
        const ambientImage = product.images.find(img => 
          img.label && (img.label.toLowerCase().includes('ambiente') || img.label.toLowerCase().includes('ambientada'))
        );
        if (ambientImage?.url) {
          console.log('  Usando imagen ambiental:', ambientImage.url);
          return ambientImage.url;
        }
        
        // Prioridad 2: Primera imagen del array
        if (product.images[0]?.url) {
          console.log('  Usando primera imagen:', product.images[0].url);
          return product.images[0].url;
        }
      }
      
      // Fallback
      console.warn('‚ö†Ô∏è  Producto sin imagen:', product.name);
      return '/public/img/subcategorias/notfound.png';
    }

    // Obtiene la imagen de una subcategor√≠a/familia
    function getSubcategoryImage(categoryId, familyId) {
      if (!categoryId || !familyId) return '/public/img/subcategorias/notfound.png';
      
      // Mapeo especial para casos que no siguen la convenci√≥n est√°ndar
      const specialMappings = {
        'brazos-ajustables-operativas-40': 'brazo ajustable 40',
        'brazos-fijos-operativas': 'brazos fijos operativas'
      };
      
      // Verificar si existe un mapeo especial
      let normalizedFamilyId;
      if (specialMappings[familyId.toLowerCase()]) {
        normalizedFamilyId = specialMappings[familyId.toLowerCase()];
      } else {
        // Normalizar el ID de la familia: convertir guiones a espacios y a min√∫sculas
        normalizedFamilyId = familyId.toLowerCase().replace(/-/g, ' ');
      }
      
      // Construir la ruta de la imagen
      const imagePath = `/public/img/subcategorias/${categoryId}/${normalizedFamilyId}.jpg`;
      
      return imagePath;
    }

    function renderOperativosSearch(term) {
      const grid = document.getElementById('products-grid');
      operativosSearchTerm = term;
      if (!term.trim()) {
        renderCategoryProducts('operativos');
        return;
      }

      const products = Object.values(catalogData.products.operativos || {}).flatMap(family => family.products || []);
      const filtered = products.filter(product => product.name.toLowerCase().includes(term.toLowerCase()));

      breadcrumb.category = 'operativos';
      breadcrumb.subcategory = null;
      updateBreadcrumb();
      grid.innerHTML = '';

      if (!filtered.length) {
        grid.innerHTML = '<p class="text-slate-600">Sin resultados para esa b√∫squeda.</p>';
        return;
      }

      filtered.forEach(product => {
        const article = document.createElement('article');
        article.className = 'border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm cursor-pointer hover:shadow-md transition-shadow';
        article.innerHTML = `
          <div class="product-image-container aspect-[4/3] bg-white cursor-zoom-in flex items-center justify-center" title="Click para ampliar">
            <img class="w-full h-full object-contain" loading="lazy" src="${getBestProductImage(product)}" alt="${product.name}">
          </div>
          <div class="p-4 space-y-1">
            <h3 class="product-name text-lg leading-tight">${product.name}</h3>
            <p class="text-slate-500 text-sm">${product.material}</p>
            ${product.description ? `<button class="mt-2 text-sm font-medium text-blue-600 hover:text-blue-700 transition-colors">Ver detalles ‚Üí</button>` : ''}
          </div>
        `;

        if (product.description) {
          article.addEventListener('click', () => {
            navigateToProduct(product);
          });
        }

        grid.appendChild(article);
      });
      applyAllProductNameFormats();
    }

    function renderSubcategoryProducts(category, subcategory, subsubcategory = null) {
      const grid = document.getElementById('products-grid');
      const fragment = document.createDocumentFragment();
      setCategoryExtras(category);
      
      const subcategoryData = catalogData.products[category][subcategory];
      
      // Verificar si esta subcategor√≠a tiene subfamilias anidadas (como KYOS)
      if (subsubcategory) {
        // Renderizar productos de una subfamilia espec√≠fica
        const products = subcategoryData[subsubcategory]?.products || [];
        breadcrumb.category = category;
        breadcrumb.subcategory = subcategory;
        breadcrumb.subsubcategory = subsubcategory;
        updateBreadcrumb();

        products.forEach(product => {
          const article = document.createElement('article');
          article.className = 'border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm cursor-pointer hover:shadow-md transition-shadow';
          article.dataset.action = 'product';
          article._productData = product;
          article._categoryId = category;
          article._familyId = subsubcategory;
          article.innerHTML = `
            <div class="product-image-container aspect-[4/3] bg-white cursor-zoom-in flex items-center justify-center" title="Click para ampliar">
              <img loading="lazy" class="w-full h-full object-contain" src="${getBestProductImage(product)}" alt="${product.name}">
            </div>
            <div class="p-4 space-y-1">
              <h3 class="product-name text-lg leading-tight">${product.name}</h3>
              <p class="text-slate-500 text-sm">${normalizeText(product.material)}</p>
              ${product.description ? `<button class="mt-2 text-sm font-medium text-blue-600 hover:text-blue-700 transition-colors">Ver detalles ‚Üí</button>` : ''}
            </div>
          `;
          fragment.appendChild(article);
        });
      } else if (subcategoryData && !subcategoryData.products) {
        // Tiene subfamilias anidadas, mostrar las subfamilias
        breadcrumb.category = category;
        breadcrumb.subcategory = subcategory;
        breadcrumb.subsubcategory = null;
        updateBreadcrumb();

        Object.entries(subcategoryData).forEach(([key, subfamily]) => {
          // Ignorar propiedades metadata (id, name, description)
          if (key === 'id' || key === 'name' || key === 'description') return;
          
          if (subfamily.products) {
            const familyCard = document.createElement('article');
            familyCard.className = 'border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm cursor-pointer hover:shadow-md transition-shadow';
            familyCard.innerHTML = `
              <div class="aspect-[4/3] bg-white overflow-hidden flex items-center justify-center">
                <img loading="lazy" class="w-full h-full object-contain" src="${getSubcategoryImage(category, subfamily.id)}" alt="${subfamily.name}" onerror="this.src='/public/img/subcategorias/notfound.png'">
              </div>
              <div class="p-4">
                <h3 class="text-xl font-semibold text-blue-600">${subfamily.name}</h3>
                <p class="text-slate-600 text-sm mt-1">${normalizeText(subfamily.description || '')}</p>
                <p class="text-slate-500 text-sm mt-2">${subfamily.products.length} modelos</p>
              </div>
            `;
            familyCard.addEventListener('click', () => {
              renderSubcategoryProducts(category, subcategory, subfamily.id);
            });
            fragment.appendChild(familyCard);
          }
        });
      } else {
        // Productos directos sin subfamilias
        const products = subcategoryData?.products || [];
        breadcrumb.category = category;
        breadcrumb.subcategory = subcategory;
        breadcrumb.subsubcategory = null;
        updateBreadcrumb();

        products.forEach(product => {
          const prod = getProductDefaults(product);
          const article = document.createElement('article');
          article.className = 'border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm cursor-pointer hover:shadow-md transition-shadow';
          article.dataset.action = 'product';
          article._productData = product;
          article._categoryId = category;
          article._familyId = subcategory;
          article.innerHTML = `
            <div class="product-image-container aspect-[4/3] bg-white cursor-zoom-in flex items-center justify-center" title="Click para ampliar">
              <img loading="lazy" class="w-full h-full object-contain" src="${getBestProductImage(product)}" alt="${prod.name}" onerror="this.src='/public/img/subcategorias/notfound.png'">
            </div>
            <div class="p-4 space-y-1">
              <h3 class="product-name text-lg leading-tight">${prod.name}</h3>
              <p class="text-slate-500 text-sm">${normalizeText(prod.material)}</p>
              <button class="mt-2 text-sm font-medium text-blue-600 hover:text-blue-700 transition-colors">Ver detalles ‚Üí</button>
            </div>
          `;
          fragment.appendChild(article);
        });
      }
      
      grid.innerHTML = '';
      grid.appendChild(fragment);
      applyAllProductNameFormats();
    }

    function renderCategoryProducts(category) {
      const grid = document.getElementById('products-grid');
      const fragment = document.createDocumentFragment();
      setCategoryExtras(category);
      breadcrumb.category = category;
      breadcrumb.subcategory = null;
      breadcrumb.subsubcategory = null;

      const categoryProducts = catalogData.products[category] || catalogData[category] || catalogData.products[category?.toLowerCase?.()] || catalogData[category?.toLowerCase?.()];
      
      if (categoryProducts && typeof categoryProducts === 'object' && !Array.isArray(categoryProducts)) {
        // Tiene subcategor√≠as
        Object.entries(categoryProducts).forEach(([key, family]) => {
          // Ignorar propiedades metadata (id, name, description)
          if (key === 'id' || key === 'name' || key === 'description') return;
          
          // Verificar si es una familia normal (con products) o tiene subfamilias anidadas
          const productCount = family.products ? family.products.length : 
            Object.entries(family).filter(([k, item]) => k !== 'id' && k !== 'name' && k !== 'description' && item.products).reduce((sum, [, sub]) => sum + sub.products.length, 0);
          
          const familyCard = document.createElement('article');
          familyCard.className = 'border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm cursor-pointer hover:shadow-md transition-shadow';
          familyCard.innerHTML = `
            <div class="aspect-[4/3] bg-white overflow-hidden flex items-center justify-center">
              <img loading="lazy" class="w-full h-full object-contain" src="${getSubcategoryImage(category, family.id)}" alt="${family.name || family.id}" onerror="this.src='/public/img/subcategorias/notfound.png'">
            </div>
            <div class="p-4">
              <h3 class="text-xl font-semibold text-blue-600">${family.name || family.id}</h3>
              ${family.description ? `<p class="text-slate-600 text-sm mt-1">${family.description}</p>` : ''}
              <p class="text-slate-500 text-sm mt-2">${productCount} modelos</p>
            </div>
          `;
          familyCard.addEventListener('click', () => {
            renderSubcategoryProducts(category, family.id);
          });
          fragment.appendChild(familyCard);
        });
      } else {
        // Es un array directo de productos
        categoryProducts.forEach(product => {
          const prod = getProductDefaults(product);
          
          // Si el producto tiene un 'link', redirigir directamente
          if (product.link) {
            const article = document.createElement('a');
            article.href = product.link;
            article.className = 'border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow block';
            article.innerHTML = `
              <div class="product-image-container aspect-[4/3] bg-white cursor-zoom-in flex items-center justify-center" title="Click para ampliar">
                <img loading="lazy" class="w-full h-full object-contain" src="${getBestProductImage(product)}" alt="${prod.name}" onerror="this.src='/public/img/subcategorias/notfound.png'">
              </div>
              <div class="p-4 space-y-1">
                <h3 class="product-name text-lg leading-tight">${prod.name}</h3>
                <p class="text-slate-500 text-sm">${prod.material}</p>
                <button class="mt-2 text-sm font-medium text-blue-600 hover:text-blue-700 transition-colors">Ver detalles ‚Üí</button>
              </div>
            `;
            fragment.appendChild(article);
          } else {
            const article = document.createElement('article');
            article.className = 'border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm cursor-pointer hover:shadow-md transition-shadow';
            article.dataset.action = 'product';
            article._productData = product;
            article.innerHTML = `
              <div class="product-image-container aspect-[4/3] bg-white cursor-zoom-in flex items-center justify-center" title="Click para ampliar">
                <img loading="lazy" class="w-full h-full object-contain" src="${getBestProductImage(product)}" alt="${prod.name}" onerror="this.src='/public/img/subcategorias/notfound.png'">
              </div>
              <div class="p-4 space-y-1">
                <h3 class="product-name text-lg leading-tight">${prod.name}</h3>
                <p class="text-slate-500 text-sm">${prod.material}</p>
                <button class="mt-2 text-sm font-medium text-blue-600 hover:text-blue-700 transition-colors">Ver detalles ‚Üí</button>
              </div>
            `;
            fragment.appendChild(article);
          }
        });
      }
      
      grid.innerHTML = '';
      grid.appendChild(fragment);
      updateBreadcrumb();
      applyAllProductNameFormats();
    }

    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.category-btn').forEach(b => {
          b.classList.remove('bg-blue-600', 'text-white');
          b.classList.add('bg-slate-200', 'text-slate-700');
        });
        btn.classList.remove('bg-slate-200', 'text-slate-700');
        btn.classList.add('bg-blue-600', 'text-white');
        const category = btn.dataset.category;
        if (category === 'all') {
          breadcrumb.category = null;
          breadcrumb.subcategory = null;
          breadcrumb.subsubcategory = null;
          renderAllProducts();
        } else {
          renderCategoryProducts(category);
        }
      });
    });

    const searchInput = document.getElementById('search-input');
    const clearSearch = document.getElementById('clear-search');

    function normalizeText(text = '') {
      return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/\p{Diacritic}+/gu, '')
        .replace(/[^a-z0-9\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function getSynonyms(term) {
      const map = {
        escolar: ['escuela', 'school', 'colegio', 'clase'],
        industrial: ['industria', 'planta', 'fabrica'],
        ejecutivo: ['ejecutiva', 'executive'],
        directivo: ['directiva', 'director', 'gerencia'],
        operativo: ['operativa', 'oficina', 'trabajo'],
        visitante: ['visita', 'sala de espera'],
        mesa: ['mesas', 'surface', 'table'],
        banca: ['banco', 'bench'],
        confortables: ['lounge', 'sofa', 'butaca'],
        silla: ['sillas', 'chair', 'asiento']
      };
      const nterm = normalizeText(term);
      const extra = Object.entries(map)
        .filter(([, arr]) => arr.some(s => normalizeText(s) === nterm || nterm.includes(normalizeText(s)) || normalizeText(s).includes(nterm)))
        .map(([key]) => key);
      return [term, ...extra];
    }

    function bigramSimilarity(a, b) {
      const toBigrams = (s) => {
        const n = normalizeText(s);
        const grams = [];
        for (let i = 0; i < n.length - 1; i++) grams.push(n.slice(i, i + 2));
        return grams;
      };
      const ga = toBigrams(a);
      const gb = toBigrams(b);
      if (!ga.length || !gb.length) return 0;
      const setA = new Set(ga);
      const setB = new Set(gb);
      let intersect = 0;
      setA.forEach(g => { if (setB.has(g)) intersect++; });
      return intersect / Math.max(setA.size, setB.size);
    }

    function getAllProductsFlat() {
      const list = [];
      Object.entries(catalogData.products).forEach(([catId, catValue]) => {
        if (catValue && typeof catValue === 'object' && !Array.isArray(catValue)) {
          Object.entries(catValue).forEach(([familyId, familyValue]) => {
            if (familyId === 'id' || familyId === 'name' || familyId === 'description') return;
            const productsArr = Array.isArray(familyValue) ? familyValue : (familyValue?.products || []);
            productsArr.forEach(p => list.push({ catId, familyId, product: p }));
          });
        } else if (Array.isArray(catValue)) {
          catValue.forEach(p => list.push({ catId, familyId: catId, product: p }));
        }
      });
      return list;
    }

    function navigateToProductDirect(categoria, familia, productoId) {
      if (!categoria || !familia || !productoId) return;
      const url = `producto.html?categoria=${encodeURIComponent(categoria)}&familia=${encodeURIComponent(familia)}&producto=${encodeURIComponent(productoId)}`;
      window.location.href = url;
    }

    function renderSearchResults(query) {
      const normalizedQuery = normalizeText(query);
      const synonymQueries = getSynonyms(normalizedQuery);
      const grid = document.getElementById('products-grid');
      const fragment = document.createDocumentFragment();
      const noResults = document.getElementById('no-results');
      setCategoryExtras(null);
      breadcrumb.category = null;
      breadcrumb.subcategory = null;
      breadcrumb.subsubcategory = null;
      updateBreadcrumb();

      const results = getAllProductsFlat().filter(({ product, catId, familyId }) => {
        const prod = getProductDefaults(product);
        const haystack = normalizeText(`${prod.name} ${prod.material} ${prod.description} ${catId} ${familyId}`);
        return synonymQueries.some(term => {
          const nq = normalizeText(term);
          if (!nq) return false;
          if (haystack.includes(nq)) return true;
          return bigramSimilarity(haystack, nq) >= 0.35;
        });
      });

      if (!results.length) {
        grid.innerHTML = '';
        noResults.classList.remove('hidden');
        return;
      }
      noResults.classList.add('hidden');

      results.forEach(({ catId, familyId, product }) => {
        const prod = getProductDefaults(product);
        const article = document.createElement('article');
        article.className = 'border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm cursor-pointer hover:shadow-md transition-shadow';
        article.dataset.action = 'product';
        article._productData = product;
        article._categoryId = catId;
        article._familyId = familyId;
        article.innerHTML = `
          <div class="product-image-container aspect-[4/3] bg-white cursor-zoom-in flex items-center justify-center" title="Click para ampliar">
            <img loading="lazy" class="w-full h-full object-contain" src="${getBestProductImage(product)}" alt="${prod.name}" onerror="this.src='/public/img/subcategorias/notfound.png'">
          </div>
          <div class="p-4 space-y-1">
            <p class="text-xs uppercase tracking-wide text-brand-primary font-semibold">${catId} ¬∑ ${familyId}</p>
            <h3 class="product-name text-lg leading-tight">${prod.name}</h3>
            <p class="text-slate-500 text-sm line-clamp-2">${prod.material}</p>
            <button class="mt-2 text-sm font-medium text-blue-600 hover:text-blue-700 transition-colors">Ver detalles ‚Üí</button>
          </div>
        `;
        fragment.appendChild(article);
      });
      
      grid.innerHTML = '';
      grid.appendChild(fragment);
      applyAllProductNameFormats();
    }

    // Initialize Filter Dropdown
    function initFilterDropdown() {
      const filterBtn = document.getElementById('filter-dropdown-btn');
      const filterMenu = document.getElementById('filter-dropdown-menu');
      const filterContent = document.getElementById('filter-dropdown-content');

      // Helper: Create element with classes and data
      const createElement = (tag, classes, text, data = {}) => {
        const el = document.createElement(tag);
        el.className = classes;
        if (text) el.textContent = text;
        Object.entries(data).forEach(([key, val]) => el.dataset[key] = val);
        return el;
      };

      // Helper: Calculate product count in a family
      const countProducts = (family) => {
        if (family.products) return family.products.length;
        return Object.entries(family)
          .filter(([k, item]) => k !== 'id' && k !== 'name' && k !== 'description' && item.products)
          .reduce((sum, [, sub]) => sum + sub.products.length, 0);
      };

      // Note: Product list creation removed - showing only subfamilies

      // Generate filter items from catalogData
      catalogData.categories.forEach(category => {
        const categoryProducts = catalogData.products[category.id];
        if (!categoryProducts) return;

        const categoryDiv = createElement('div', 'mb-4');
        
        const categoryHeader = createElement(
          'div',
          'px-2 py-1 font-semibold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide border-b border-slate-200 dark:border-slate-700 mb-2 cursor-pointer hover:text-brand-primary transition-colors',
          category.name,
          { action: 'category', categoryId: category.id }
        );
        
        categoryDiv.appendChild(categoryHeader);

        if (typeof categoryProducts === 'object' && !Array.isArray(categoryProducts)) {
          const subfamiliesDiv = createElement('div', 'space-y-1 ml-2');
          
          Object.entries(categoryProducts).forEach(([familyId, family]) => {
            if (familyId === 'id' || familyId === 'name' || familyId === 'description') return;
            
            const familyName = typeof family === 'object' ? (family.name || familyId) : familyId;
            const productCount = countProducts(family);
            
            const familyItem = createElement(
              'div',
              'px-2 py-1.5 text-slate-700 dark:text-slate-300 text-xs rounded hover:bg-slate-100 dark:hover:bg-slate-800 cursor-pointer transition-colors',
              productCount > 0 ? `${familyName} (${productCount})` : familyName,
              { 
                action: 'family', 
                categoryId: category.id, 
                familyId
              }
            );
            
            subfamiliesDiv.appendChild(familyItem);
            
            // Add sub-subfamilies
            if (family && typeof family === 'object' && !family.products) {
              const subSubfamiliesDiv = createElement('div', 'space-y-1 ml-4');
              
              Object.entries(family).forEach(([subFamilyId, subFamily]) => {
                if (subFamilyId === 'id' || subFamilyId === 'name' || subFamilyId === 'description') return;
                
                if (subFamily && subFamily.products) {
                  const subFamilyName = subFamily.name || subFamilyId;
                  const productCount = subFamily.products.length;
                  
                  const subFamilyItem = createElement(
                    'div',
                    'px-2 py-1 text-slate-600 dark:text-slate-400 text-xs rounded hover:bg-slate-100 dark:hover:bg-slate-800 cursor-pointer transition-colors',
                    `${subFamilyName} (${productCount})`,
                    { 
                      action: 'subfamily', 
                      categoryId: category.id, 
                      familyId, 
                      subFamilyId
                    }
                  );
                  
                  subSubfamiliesDiv.appendChild(subFamilyItem);
                }
              });
              
              if (subSubfamiliesDiv.children.length > 0) {
                subfamiliesDiv.appendChild(subSubfamiliesDiv);
              }
            }
          });
          
          categoryDiv.appendChild(subfamiliesDiv);
        }
        
        filterContent.appendChild(categoryDiv);
      });

      // Event delegation - Single click handler for all items
      filterContent.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        
        e.stopPropagation();
        const { action, categoryId, familyId, subFamilyId, productId, hasProducts } = target.dataset;
        
        switch (action) {
          case 'category':
            renderCategoryProducts(categoryId);
            filterMenu.classList.add('hidden');
            break;
            
          case 'family':
            renderSubcategoryProducts(categoryId, familyId);
            filterMenu.classList.add('hidden');
            break;
            
          case 'subfamily':
            renderSubcategoryProducts(categoryId, familyId, subFamilyId);
            filterMenu.classList.add('hidden');
            break;
        }
      });

      // Note: Mouse hover handlers for products removed - only showing subfamilies

      // Toggle dropdown on button click
      if (filterBtn) {
        filterBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          filterMenu.classList.toggle('hidden');
        });
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!filterBtn?.contains(e.target) && !filterMenu?.contains(e.target)) {
          filterMenu?.classList.add('hidden');
        }
      });
    }

    if (searchInput) {
      searchInput.addEventListener('input', () => {
        const q = searchInput.value.trim().toLowerCase();
        if (!q) {
          document.getElementById('no-results').classList.add('hidden');
          renderAllProducts();
          return;
        }
        renderSearchResults(q);
      });
    }

    if (clearSearch && searchInput) {
      clearSearch.addEventListener('click', () => {
        searchInput.value = '';
        document.getElementById('no-results').classList.add('hidden');
        renderAllProducts();
      });
    }

    // Debounce utility
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function getCategoryImage(catId) {
      if (!catId) return '/public/img/categorias/directivos.png';
      return `/public/img/categorias/${catId}.png`;
    }

    function renderAllProducts() {
      try {
        if (!catalogData || !catalogData.products) {
          console.error('‚ùå catalogData o catalogData.products vac√≠o', catalogData);
          return;
        }
        
        const grid = document.getElementById('products-grid');
        if (!grid) {
          console.error('‚ùå No se encontr√≥ #products-grid');
          return;
        }
        
        const fragment = document.createDocumentFragment();
        
        setCategoryExtras(null);
        breadcrumb.category = null;
        breadcrumb.subcategory = null;
        breadcrumb.subsubcategory = null;
        updateBreadcrumb();

        Object.entries(catalogData.products).forEach(([catId, catProducts]) => {
          // Todas las categor√≠as deben mostrarse como tarjetas, incluso si son arrays
          const categoryCard = document.createElement('article');
          categoryCard.className = 'border border-slate-200 rounded-lg bg-white shadow-sm p-4 cursor-pointer hover:shadow-md';
          const catName = catalogData.categories.find(c => c.id === catId)?.name;
          
          // Contar productos/familias seg√∫n la estructura
          let itemCount = 0;
          if (Array.isArray(catProducts)) {
            itemCount = catProducts.length;
          } else if (typeof catProducts === 'object') {
            itemCount = Object.keys(catProducts).length;
          }
          
          categoryCard.innerHTML = `
            <div class="category-image-container aspect-[4/3] bg-white overflow-hidden rounded-md mb-3 cursor-zoom-in flex items-center justify-center" title="Click para ampliar">
              <img loading="lazy" class="w-full h-full object-contain" src="${getCategoryImage(catId)}" alt="${catName}" onerror="this.src='/public/img/subcategorias/notfound.png'">
            </div>
            <h3 class="text-xl font-semibold text-blue-600">${catName}</h3>
            <p class="text-slate-600 text-sm">${itemCount} ${Array.isArray(catProducts) ? 'productos' : 'familias'}</p>
          `;
          categoryCard.dataset.categoryId = catId;
          categoryCard.dataset.action = 'category';
          fragment.appendChild(categoryCard);
        });
        
        grid.innerHTML = '';
        grid.appendChild(fragment);
        applyAllProductNameFormats();
        console.log('‚úì renderAllProducts completado');
      } catch (error) {
        console.error('‚ùå Error en renderAllProducts:', error);
      }
    }

    // Event delegation para productos y categor√≠as del grid
    const productsGrid = document.getElementById('products-grid');
    if (productsGrid) {
      productsGrid.addEventListener('click', (e) => {
        // Manejar clic en categor√≠a
        const categoryCard = e.target.closest('[data-action="category"]');
        if (categoryCard) {
          const categoryId = categoryCard.dataset.categoryId;
          if (categoryId) {
            renderCategoryProducts(categoryId);
            return;
          }
        }
        
        // Manejar clic en producto
        const article = e.target.closest('[data-action="product"]');
        if (article && article._productData) {
          // Para resultados de b√∫squeda que almacenan catId y familyId
          if (article._categoryId && article._familyId) {
            navigateToProductDirect(article._categoryId, article._familyId, article._productData.id);
          } else {
            // Para navegaci√≥n normal usando breadcrumb
            navigateToProduct(article._productData);
          }
        }
      });
    }

    // Funci√≥n para formatear el nombre del producto en dos l√≠neas
    function applyProductNameFormat(element) {
      if (!element) return;
      const name = element.textContent.trim();
      const modeloMatch = name.match(/^(.+?)\s+(modelo\s+.+)$/i);
      if (modeloMatch) {
        element.innerHTML = `<span class="block font-semibold">${modeloMatch[1]}</span><span class="block text-sm text-slate-600 dark:text-slate-400">${modeloMatch[2]}</span>`;
      }
    }
    
    // Aplicar formato despu√©s de renderizar
    function applyAllProductNameFormats() {
      document.querySelectorAll('.product-name').forEach(el => {
        applyProductNameFormat(el);
      });
    }

    function getProductDefaults(product) {
      return {
        name: product.name || 'Producto sin nombre',
        comercial_name: product.comercial_name || product.name || 'Producto sin nombre',
        material: product.material || 'Material no especificado',
        description: product.description || 'Descripci√≥n no disponible',
        image: product.image || '/public/img/subcategorias/notfound.png',
        specifications: product.specifications || { nota: 'Especificaciones pendientes' },
        recursos: product.recursos || null
      };
    }

    // Funci√≥n para navegar a la p√°gina de producto individual
    function navigateToProduct(product) {
      // Usar breadcrumb para obtener categor√≠a y familia
      const categoria = breadcrumb.category;
      const familia = breadcrumb.subsubcategory || breadcrumb.subcategory;
      const productoId = product.id;
      
      if (!categoria || !familia || !productoId) {
        console.error('Faltan par√°metros para navegar:', { categoria, familia, productoId });
        return;
      }
      
      // Construir URL y navegar
      const url = `producto.html?categoria=${encodeURIComponent(categoria)}&familia=${encodeURIComponent(familia)}&producto=${encodeURIComponent(productoId)}`;
      window.location.href = url;
    }

    // Detectar par√°metro de categor√≠a en la URL y pre-filtrar
    function initializeFromURL() {
      const params = new URLSearchParams(window.location.search);
      const categoryParam = params.get('categoria');
      
      if (categoryParam) {
        renderCategoryProducts(categoryParam);
      }
    }

    async function initCatalog() {
      try {
        console.log('‚è≥ initCatalog comenzando...');
        const debug = document.getElementById('debug-info');
        if (debug) {
          debug.style.display = 'block';
          debug.innerHTML += '<div>‚è≥ Cargando datos...</div>';
        }
        
        await loadCatalogData();
        console.log('‚úì loadCatalogData completado, catalogData:', catalogData);
        if (debug) {
          const catCount = catalogData?.categories?.length || 0;
          const prodCount = Object.keys(catalogData?.products || {}).length;
          debug.innerHTML += `<div>‚úì Datos: ${catCount} categor√≠as, ${prodCount} productos</div>`;
        }
        
        renderAllProducts();
        console.log('‚úì renderAllProducts ejecutado');
        if (debug) {
          const prodCount = document.getElementById('products-grid')?.children?.length || 0;
          debug.innerHTML += `<div>‚úì Render: ${prodCount} elementos en grid</div>`;
        }
        
        initializeFromURL();
        initFilterDropdown();
        console.log('‚úì initCatalog completado');
      } catch (error) {
        console.error('‚ùå Error en initCatalog:', error);
        const debug = document.getElementById('debug-info');
        if (debug) {
          debug.innerHTML += `<div style="color: red;">‚ùå ${error.message}</div>`;
        }
      }
    }

    console.log('üìç Iniciando cat√°logo...');
    initCatalog();
    
    // Funcionalidad de lightbox para im√°genes
    function openLightbox(imageSrc, imageLabel) {
      const lightbox = document.getElementById('image-lightbox');
      const lightboxImg = document.getElementById('lightbox-image');
      const lightboxLabel = document.getElementById('lightbox-label');
      
      lightboxImg.src = imageSrc;
      lightboxImg.alt = imageLabel || 'Imagen del producto';
      lightboxLabel.textContent = imageLabel || '';
      
      lightbox.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function closeLightbox(event) {
      if (event && event.target.id !== 'image-lightbox') return;
      
      const lightbox = document.getElementById('image-lightbox');
      lightbox.classList.add('hidden');
      document.body.style.overflow = '';
    }
    
    // Cerrar con tecla ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeLightbox();
    });
    
    // Event delegation para hacer clic en im√°genes de productos/categor√≠as
    document.addEventListener('click', (e) => {
      const imgContainer = e.target.closest('.product-image-container, .category-image-container');
      if (imgContainer && e.target.tagName === 'IMG') {
        e.preventDefault();
        e.stopPropagation();
        openLightbox(e.target.src, e.target.alt);
      }
    });
  </script>
  <script src="../public/js/header.js"></script>
  
  <!-- Modal Lightbox para Im√°genes -->
  <div id="image-lightbox" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4 animate-fade-in" onclick="closeLightbox(event)">
    <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white hover:text-brand-primary transition-colors p-2 rounded-full hover:bg-white/10" aria-label="Cerrar vista ampliada">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    <div class="max-w-7xl w-full max-h-full flex flex-col items-center" onclick="event.stopPropagation()">
      <img id="lightbox-image" src="" alt="" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl">
      <p id="lightbox-label" class="mt-4 text-white text-lg font-medium"></p>
    </div>
  </div>
</body>
</html>
